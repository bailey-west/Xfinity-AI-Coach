<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Coaching Tool</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Xfinity-inspired Colors */
            --primary-color: #0061a6;
            --primary-color-dark: #004a80;
            --gradient-primary: linear-gradient(90deg, #0061a6, #007bff);
            --light-color: #fff;
            --text-color: #18181b;
            --text-color-light: #a1a1aa;
            --bg-color: #f4f7fa;
            --border-color: #e4e4e7;
            --sidebar-bg: #18181b;
            --card-bg: #ffffff;
            --danger-color: #e74c3c;
            --danger-color-dark: #c0392b;
            --success-color: #007a4a;
            --success-bg: #f0fff8;
            --warn-bg: #fdfae7;
            --warn-border: #fbf0b5;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);

            /* Sidebar Variables */
            --sidebar-width-open: 260px;
            --sidebar-width-closed: 78px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* App Layout */
        .app-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width-open) 1fr;
            grid-template-rows: 1fr;
            min-height: 100vh;
            transition: grid-template-columns 0.3s ease-in-out;
        }
        
        .app-layout.sidebar-collapsed {
            grid-template-columns: var(--sidebar-width-closed) 1fr;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            overflow-y: auto;
            overflow-x: hidden;
            transition: width 0.3s ease-in-out;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 25px;
            left: var(--sidebar-width-open);
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            color: var(--light-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: left 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: var(--shadow-sm);
        }
        .app-layout.sidebar-collapsed .sidebar-toggle {
            left: var(--sidebar-width-closed);
            transform: translateX(-50%) rotate(180deg);
        }
        .sidebar-toggle:hover {
            background-color: var(--primary-color);
        }
        
        .sidebar-header {
            padding: 0 10px 20px 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--light-color);
            border-bottom: 1px solid #3f3f46;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        .sidebar-header .fa-solid {
            margin-right: 10px;
            color: var(--primary-color);
            min-width: 30px;
            text-align: center;
        }
        /* Display current store in header */
        .store-badge {
            font-size: 0.5em;
            background: var(--primary-color);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            vertical-align: middle;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .app-layout.sidebar-collapsed .sidebar-header .header-text,
        .app-layout.sidebar-collapsed .sidebar-header .store-badge {
            display: none;
        }

        .sidebar-nav a {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: var(--text-color-light);
            font-weight: 500;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
            white-space: nowrap;
        }
        .sidebar-nav a .nav-text-group {
            display: flex;
            align-items: center;
        }
        .sidebar-nav a i {
            margin-right: 12px;
            width: 30px;
            text-align: center;
            transition: color 0.2s;
            font-size: 1.1em;
        }
        .app-layout.sidebar-collapsed .sidebar-nav a i {
            margin-right: 0;
        }
        .sidebar-nav a:hover {
            background-color: #27272a;
            color: var(--light-color);
            transform: translateX(3px);
        }
        .app-layout.sidebar-collapsed .sidebar-nav a:hover {
            transform: none;
        }

        .sidebar-nav a.active {
            background-color: var(--primary-color);
            color: var(--light-color);
        }
        .sidebar-nav a.active i {
            color: var(--light-color);
        }

        .app-layout.sidebar-collapsed .nav-text,
        .app-layout.sidebar-collapsed .nav-warning-icon {
            display: none;
        }
        
        .nav-warning-icon {
            color: #facc15;
            font-size: 0.9em;
            animation: blink 1.5s linear infinite;
        }
        .sidebar-nav a.active .nav-warning-icon {
            color: var(--light-color);
        }
        @keyframes blink {
            50% { opacity: 0.2; }
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #3f3f46;
        }
        .auth-button {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: var(--light-color);
            font-weight: 500;
            border-radius: 6px;
            margin: 5px;
            transition: background-image 0.3s, background-color 0.3s, transform 0.2s;
            background: var(--gradient-primary);
            border: none;
            width: calc(100% - 10px);
            cursor: pointer;
            font-size: 15px;
            text-align: left;
            white-space: nowrap;
        }
        .auth-button i {
            width: 30px;
            text-align: center;
            margin-right: 12px;
            font-size: 1.1em;
        }
        .app-layout.sidebar-collapsed .auth-button i {
            margin-right: 0;
        }

        .auth-button.sign-out {
            background-color: var(--danger-color);
            background-image: none;
        }
        .auth-button:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }
        .app-layout.sidebar-collapsed .auth-button:hover {
            transform: none;
        }

        .auth-button.sign-out:hover {
            background-color: var(--danger-color-dark);
            transform: scale(1.02);
        }
        .app-layout.sidebar-collapsed .auth-button.sign-out:hover {
            transform: none;
        }
        .app-layout.sidebar-collapsed .auth-button .auth-text {
            display: none;
        }

        /* Main Content Area */
        .main-content {
            background-color: var(--bg-color);
            padding: 20px 30px;
            overflow-y: auto;
        }
        
        .page-content {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-content.active {
            display: block;
        }
        
        /* Form Styles */
        form { 
            padding: 25px;
            background-color: var(--card-bg); 
            border-radius: 12px;
            box-shadow: var(--shadow-lg); 
            border: 1px solid var(--border-color);
            position: relative; /* For clear button positioning */
        }
        /* Clear Form Button Style */
        .clear-form-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            background: none;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            width: auto;
        }
        .clear-form-btn:hover {
            background-color: var(--danger-color);
            color: white;
            box-shadow: none;
            transform: none;
        }

        h2 {
            text-align: center;
            margin-top: 0;
            color: var(--text-color);
        }
        .form-section { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600;
        }
        label .label-hint {
            font-weight: normal;
            font-style: italic;
            color: var(--text-color-light);
            font-size: 0.9em;
            display: block;
            margin-top: 2px;
        }

        select, textarea, input[type="text"], input[type="number"], input[type="date"] { 
            width: 100%; 
            padding: 10px;
            border: 1px solid var(--border-color); 
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 97, 166, 0.1);
        }
        
        .step-notes {
            min-height: 50px;
            font-size: 13px;
            margin-top: 10px;
            position: relative;
        }
        .profile-notes {
            min-height: 80px;
            font-size: 14px;
        }

        fieldset { 
            border: 1px solid var(--border-color); 
            border-radius: 8px;
            padding: 10px 15px 15px 15px;
            margin-bottom: 20px;
        }
        legend { 
            font-weight: 600; 
            padding: 0 10px;
            font-size: 1.2em;
            color: var(--primary-color);
        }
        
        .measurement-group {
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
            margin-bottom: 10px;
        }
        .measurement-group label {
            display: inline-block;
            font-weight: normal;
            margin-right: 15px;
        }
        .measurement-group input {
            margin-right: 5px;
            vertical-align: middle;
        }

        .checkbox-group {
            margin-bottom: 10px;
        }
        .checkbox-group label { 
            display: block;
            font-weight: normal; 
            margin-top: 10px; 
            line-height: 1.4;
        }
        .checkbox-group input {
            margin-right: 8px;
            vertical-align: top;
        }
        .checkbox-group label {
            display: inline-block;
            vertical-align: middle;
            width: calc(100% - 25px);
        }

        button { 
            background: var(--gradient-primary);
            color: var(--light-color); 
            padding: 12px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { 
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }
        button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-button {
            background-color: var(--success-color);
            background-image: none;
            margin-top: 10px;
        }
        .ai-button:hover {
            background-color: #00633b;
            transform: scale(1.02);
        }
        .ai-button:disabled {
            background-color: #999;
        }
        
        /* Tracker Styles */
        #tracker-table-container {
            background-color: var(--light-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        #tracker-table {
            width: 100%;
            border-collapse: collapse;
        }
        #tracker-table th, #tracker-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        #tracker-table th {
            background-color: #f9f9f9;
        }
        .status-complete {
            color: var(--success-color);
            font-weight: bold;
        }
        .status-progress {
            color: var(--text-color-light);
            font-weight: bold;
        }
        .status-exempt {
            color: #856404;
            background-color: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            display: inline-block;
        }
        
        /* Progress Pips */
        .progress-pips {
            display: flex;
            gap: 5px;
            position: relative;
            cursor: default;
        }
        .progress-pip {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: var(--border-color);
        }
        .progress-pip.filled {
            background-color: var(--success-color);
        }
        .progress-pips .tooltip-content {
            display: none;
            position: absolute;
            bottom: 125%;
            left: 0;
            background-color: var(--sidebar-bg);
            color: var(--light-color);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            width: 250px;
            white-space: pre-wrap;
            z-index: 10;
            box-shadow: var(--shadow-md);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .progress-pips:hover .tooltip-content {
            display: block;
            opacity: 1;
        }
        
        /* NEW: Exempt Toggle Button */
        .exempt-toggle-btn {
            background: none;
            border: 1px solid #d1d5db;
            color: #6b7280;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 8px;
            width: auto;
        }
        .exempt-toggle-btn.active {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        .exempt-toggle-btn:hover {
            background-color: #f3f4f6;
            transform: none;
            box-shadow: none;
        }

        /* Copy Button */
        .copy-btn {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            width: auto;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: var(--primary-color-dark);
            transform: none;
            box-shadow: none;
        }
        .copy-btn.copied {
            background-color: var(--success-color);
        }
        .step-notes-container, .verbatim-feedback-container {
            position: relative;
        }
        
        /* Loader and Modals */
        .loader {
            display: none;
            font-size: 10px;
            margin: 10px auto;
            text-indent: -9999em;
            width: 3em;
            height: 3em;
            border-radius: 50%;
            background: var(--primary-color);
            background: linear-gradient(to right, var(--primary-color) 10%, rgba(255, 255, 255, 0) 42%);
            position: relative;
            animation: load-spinner 1.4s infinite linear;
            transform: translateZ(0);
        }
        @keyframes load-spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close-btn:hover { color: black; }
        
        /* Store Selector Modal Specifics */
        .store-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .store-btn {
            background-color: white;
            color: var(--text-color);
            border: 2px solid var(--border-color);
            padding: 20px;
            font-size: 1.1em;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .store-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Logs and Lists */
        #employee-list {
            list-style: none;
            padding: 0;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        #employee-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #employee-list li:hover { background-color: #f9f9f9; }
        
        .log-entry {
            border-bottom: 1px dashed var(--border-color);
            padding: 15px 0;
        }
        .log-entry-coaching {
            background-color: #f0f8ff;
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            border-radius: 4px;
        }

        /* Toast & Custom Prompts */
        #toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            display: none;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }
        #toast-notification.show { display: block; opacity: 1; transform: translateX(0); }
        #toast-notification.error { background-color: var(--danger-color); }
        
        /* Verbatim Output */
        #verbatim-feedback-section {
            display: none;
            background-color: var(--success-bg);
            border: 1px solid var(--success-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            position: relative;
        }
        #verbatim-feedback-output {
            font-size: 1.1em;
            line-height: 1.6;
            font-style: italic;
            color: #333;
        }

        #ai-coaching-output {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
            display: none;
        }
    </style>
</head>
<body>

    <div id="store-selector-modal" class="modal" style="display: block; background-color: var(--primary-color-dark);">
        <div class="modal-content" style="max-width: 600px; text-align: center;">
            <h2 style="color: var(--primary-color); margin-bottom: 10px;">Select Your Store</h2>
            <p>Please select the location you are working in today.</p>
            <div class="store-grid">
                <button class="store-btn" onclick="selectStore('Williston')">Williston</button>
                <button class="store-btn" onclick="selectStore('Nashua')">Nashua</button>
                <button class="store-btn" onclick="selectStore('Manchester')">Manchester</button>
                <button class="store-btn" onclick="selectStore('Rutland')">Rutland</button>
                <button class="store-btn" onclick="selectStore('Gilford')">Gilford</button>
                <button class="store-btn" onclick="selectStore('Brunswick')">Brunswick</button>
            </div>
        </div>
    </div>

    <div class="app-layout logged-out" id="app-wrapper">
        
        <nav class="sidebar-nav">
            <div class="sidebar-toggle" id="sidebar-toggle-btn">
                <i class="fa-solid fa-chevron-left"></i>
            </div>
            
            <div class="sidebar-header">
                <i class="fa-solid fa-store"></i> 
                <span class="header-text">myAI Coach</span>
                <span id="current-store-badge" class="store-badge">Williston</span>
            </div>
            
            <a href="#" class="nav-link active" onclick="openPage(event, 'Observation')">
                <span class="nav-text-group"><i class="fa-solid fa-magnifying-glass-chart"></i> <span class="nav-text">Log Observation</span></span>
            </a>
            <a href="#" class="nav-link" onclick="openPage(event, 'Coaching')">
                <span class="nav-text-group"><i class="fa-solid fa-bullhorn"></i> <span class="nav-text">Log Coaching</span></span>
            </a>
            <a href="#" class="nav-link" onclick="openPage(event, 'Tracker')">
                <span class="nav-text-group"><i class="fa-solid fa-calendar-check"></i> <span class="nav-text">Monthly Tracker</span></span>
            </a>
            <a href="#" class="nav-link" id="nav-goals" onclick="openPage(event, 'Goals')">
                <span class="nav-text-group"><i class="fa-solid fa-bullseye"></i> <span class="nav-text">Store Goals</span></span>
                <span class="nav-warning-icon" id="nav-goals-warning"><i class="fa-solid fa-exclamation-circle"></i></span>
            </a>
            <a href="#" class="nav-link" onclick="openPage(event, 'ViewLogs')">
                <span class="nav-text-group"><i class="fa-solid fa-list-alt"></i> <span class="nav-text">View Logs</span></span>
            </a>
            <a href="#" class="nav-link" onclick="openPage(event, 'Employees')">
                <span class="nav-text-group"><i class="fa-solid fa-users"></i> <span class="nav-text">Manage Employees</span></span>
            </a>
            
            <div class="sidebar-footer">
                <button class="auth-button" id="sign-in-btn">
                    <i class="fa-brands fa-google"></i> <span class="auth-text">Sign In with Google</span>
                </button>
                <button class="auth-button sign-out" id="sign-out-btn">
                    <i class="fa-solid fa-right-from-bracket"></i> <span class="auth-text">Sign Out</span>
                </button>
            </div>
        </nav>

        <main class="main-content">
        
            <div id="sign-in-container">
                <h2>Welcome to the Retail Coaching Tool</h2>
                <p>Please sign in with Google to continue.</p>
            </div>

            <div id="Observation" class="page-content active">
                <form id="obsForm">
                    <button type="button" class="clear-form-btn" onclick="resetObsForm(true)">Clear Form</button>
                    <h2>New Observation</h2>
                    
                    <div class="form-section">
                        <label for="customer-intent">Customer Intent:</label>
                        <input type="text" id="customer-intent" name="customerIntent" placeholder="e.g., Pay bill, new mobile line, equipment swap..." required>
                    </div>
                    
                    <div class="form-section">
                        <label for="employee">Employee:</label>
                        <select id="employee" name="employee" required>
                            <option value="">-- Select a Rep --</option>
                        </select>
                    </div>
                    
                    <div id="last-goal-display" class="last-goal-callout"></div>
                    
                    <fieldset>
                        <legend>G - Greet</legend>
                        <div class="measurement-group">
                            <label><input type="radio" name="great_g_measure" value="Effective"> Effective</label>
                            <label><input type="radio" name="great_g_measure" value="Partial" checked> Partial</label>
                            <label><input type="radio" name="great_g_measure" value="Did Not Demonstrate"> Did Not Demonstrate</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="g1" name="great_g" value="EA: Be personable, introduce yourself..."><label for="g1">EA: Be personable, introduce yourself...</label>
                            <input type="checkbox" id="g2" name="great_g" value="EA: Acknowledge every customer..."><label for="g2">EA: Acknowledge every customer...</label>
                            <input type="checkbox" id="g3" name="great_g" value="EA: Smile, make eye contact..."><label for="g3">EA: Smile, make eye contact...</label>
                        </div>
                        <div class="step-notes-container">
                            <textarea id="notes_g" name="notes_g" class="step-notes" placeholder="Notes for Greet..."></textarea>
                            <button type="button" class="copy-btn" id="copy-g" data-target="notes_g">Copy</button>
                        </div>
                    </fieldset>

                    <fieldset>
                         <legend>R - Relate</legend>
                         <div class="measurement-group">
                            <label><input type="radio" name="great_r_measure" value="Effective"> Effective</label>
                            <label><input type="radio" name="great_r_measure" value="Partial" checked> Partial</label>
                            <label><input type="radio" name="great_r_measure" value="Did Not Demonstrate"> Did Not Demonstrate</label>
                         </div>
                         <div class="checkbox-group">
                             <input type="checkbox" id="r1" name="great_r" value="EA: Build rapport..."><label for="r1">EA: Build rapport...</label>
                             <input type="checkbox" id="r2" name="great_r" value="OI: Take ownership..."><label for="r2">OI: Take ownership...</label>
                         </div>
                         <div class="step-notes-container">
                             <textarea id="notes_r" name="notes_r" class="step-notes" placeholder="Notes for Relate..."></textarea>
                             <button type="button" class="copy-btn" id="copy-r" data-target="notes_r">Copy</button>
                         </div>
                    </fieldset>

                    <fieldset>
                         <legend>E - Explore</legend>
                         <div class="measurement-group">
                            <label><input type="radio" name="great_e_measure" value="Effective"> Effective</label>
                            <label><input type="radio" name="great_e_measure" value="Partial" checked> Partial</label>
                            <label><input type="radio" name="great_e_measure" value="Did Not Demonstrate"> Did Not Demonstrate</label>
                         </div>
                         <div class="checkbox-group">
                             <input type="checkbox" id="e1" name="great_e" value="DN: Use T-charts..."><label for="e1">DN: Use T-charts...</label>
                             <input type="checkbox" id="e2" name="great_e" value="OI: Conduct a proactive review..."><label for="e2">OI: Conduct a proactive review...</label>
                         </div>
                         <div class="step-notes-container">
                             <textarea id="notes_e" name="notes_e" class="step-notes" placeholder="Notes for Explore..."></textarea>
                             <button type="button" class="copy-btn" id="copy-e" data-target="notes_e">Copy</button>
                         </div>
                    </fieldset>

                    <fieldset>
                         <legend>A - Ask</legend>
                         <div class="measurement-group">
                            <label><input type="radio" name="great_a_measure" value="Effective"> Effective</label>
                            <label><input type="radio" name="great_a_measure" value="Partial" checked> Partial</label>
                            <label><input type="radio" name="great_a_measure" value="Did Not Demonstrate"> Did Not Demonstrate</label>
                         </div>
                         <div class="checkbox-group">
                             <input type="checkbox" id="a1" name="great_a" value="OI: Use T-Charts..."><label for="a1">OI: Use T-Charts...</label>
                             <input type="checkbox" id="a2" name="great_a" value="OI: Stay engaged..."><label for="a2">OI: Stay engaged...</label>
                         </div>
                         <div class="step-notes-container">
                             <textarea id="notes_a" name="notes_a" class="step-notes" placeholder="Notes for Ask..."></textarea>
                             <button type="button" class="copy-btn" id="copy-a" data-target="notes_a">Copy</button>
                         </div>
                    </fieldset>

                    <fieldset>
                         <legend>T - Thank</legend>
                         <div class="measurement-group">
                            <label><input type="radio" name="great_t_measure" value="Effective"> Effective</label>
                            <label><input type="radio" name="great_t_measure" value="Partial" checked> Partial</label>
                            <label><input type="radio" name="great_t_measure" value="Did Not Demonstrate"> Did Not Demonstrate</label>
                         </div>
                         <div class="checkbox-group">
                             <input type="checkbox" id="t1" name="great_t" value="SA: Thank the customer..."><label for="t1">SA: Thank the customer...</label>
                             <input type="checkbox" id="t2" name="great_t" value="OI: Recap the solution..."><label for="t2">OI: Recap the solution...</label>
                         </div>
                         <div class="step-notes-container">
                             <textarea id="notes_t" name="notes_t" class="step-notes" placeholder="Notes for Thank..."></textarea>
                             <button type="button" class="copy-btn" id="copy-t" data-target="notes_t">Copy</button>
                         </div>
                    </fieldset>
                    
                    <div class="form-section">
                        <label for="notes">Overall Summary Notes:</label>
                        <textarea id="notes" name="notes" rows="5" placeholder="Overall strengths, opportunities, or AI-generated note..."></textarea>
                    </div>
                    <div class="form-section">
                        <button type="button" class="ai-button" id="generate-and-log-ai-summary" style="background: var(--gradient-primary); width: 100%; margin-top: 0; font-size: 1.1em; padding: 14px;">Generate AI Notes & Log Observation</button>
                        <div class="loader" id="summary-loader"></div>
                    </div>
                    
                    <div id="verbatim-feedback-section">
                        <h3>Manager Verbatim (For Employee)</h3>
                        <div class="verbatim-feedback-container">
                            <div id="verbatim-feedback-output"></div>
                            <button type="button" class="copy-btn" id="copy-verbatim" data-target="verbatim-feedback-output">Copy</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div id="Coaching" class="page-content">
                <form id="coachingForm">
                    <button type="button" class="clear-form-btn" id="clear-coaching-btn">Clear Form</button>
                    <h2>Log Coaching Session</h2>
                    <div class="form-section">
                        <label for="coaching-employee-select">Employee:</label>
                        <select id="coaching-employee-select" name="employeeId" required>
                            <option value="">-- Select a Rep --</option>
                        </select>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-section">
                            <label for="coaching-date">Session Date:</label>
                            <input type="date" id="coaching-date" name="date" required>
                        </div>
                        <div class="form-section">
                            <label for="coaching-tnps">tNPS Score (Optional):</label>
                            <input type="number" id="coaching-tnps" name="tnps" placeholder="e.g., 63.6">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-section">
                            <label for="coaching-sales">Sales Metric (Optional):</label>
                            <input type="text" id="coaching-sales" name="sales" placeholder="e.g., 10 mobile lines">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <label for="coaching-progress">Progress Made: <span class="label-hint" id="ai-rec-progress">Asking...</span></label>
                        <textarea id="coaching-progress" name="progress" class="profile-notes" rows="3" placeholder="Raw notes..."></textarea>
                    </div>
                    <div class="form-section">
                        <label for="coaching-obstacles">Challenges/Obstacles: <span class="label-hint" id="ai-rec-obstacles">Asking...</span></label>
                        <textarea id="coaching-obstacles" name="obstacles" class="profile-notes" rows="3" placeholder="Raw notes..."></textarea>
                    </div>
                    <div class="form-section">
                        <label for="coaching-actionplan">Action Plan: <span class="label-hint" id="ai-rec-actionplan">Asking...</span></label>
                        <textarea id="coaching-actionplan" name="actionPlan" class="profile-notes" rows="3" placeholder="Raw SMART goal..."></textarea>
                    </div>

                    <button type="button" class="ai-button" id="generate-ai-coaching-notes" style="background: var(--gradient-primary); margin-top: 0; margin-bottom: 20px; font-size: 1.1em; padding: 14px;">Generate AI-Assisted Notes & Log Session</button>
                    <div class="loader" id="coaching-notes-loader"></div>
                </form>
            </div>
            
            <div id="Tracker" class="page-content">
                <h2 id="tracker-title">Monthly Goal Tracker</h2>
                <p id="tracker-subtitle" style="text-align: center; margin-top: -10px; margin-bottom: 20px; font-size: 1.1em; color: var(--text-color-light);"></p>
                <div id="tracker-table-container">
                    <table id="tracker-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Role</th>
                                <th>Observations (Goal: 4)</th>
                                <th>Coaching Sessions (Goal: 2)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tracker-table-body"></tbody>
                    </table>
                </div>
                <div id="Goals" class="page-content">
                <form id="goalsForm">
                    <h2>Store Monthly Goals</h2>
                    <p style="text-align: center; margin-top: -10px; margin-bottom: 20px; color: var(--text-color-light);">Set the store-wide goals for the current fiscal month. All AI-generated SMART goals will reference these numbers.</p>
                    
                    <div class="goals-grid">
                        <div class="form-section">
                            <label for="goal-xm">XM (Xfinity Mobile)</label>
                            <input type="number" id="goal-xm" name="xm" placeholder="e.g., 40">
                        </div>
                        <div class="form-section">
                            <label for="goal-hsi">HSI (Internet)</label>
                            <input type="number" id="goal-hsi" name="hsi" placeholder="e.g., 20">
                        </div>
                        <div class="form-section">
                            <label for="goal-video">Video</label>
                            <input type="number" id="goal-video" name="video" placeholder="e.g., 10">
                        </div>
                        <div class="form-section">
                            <label for="goal-cdv">CDV (Voice)</label>
                            <input type="number" id="goal-cdv" name="cdv" placeholder="e.g., 5">
                        </div>
                        <div class="form-section">
                            <label for="goal-xhs">XHS (Home Security)</label>
                            <input type="number" id="goal-xhs" name="xhs" placeholder="e.g., 5">
                        </div>
                        <div class="form-section">
                            <label for="goal-upgrades">Device Upgrades</label>
                            <input type="number" id="goal-upgrades" name="upgrades" placeholder="e.g., 15">
                        </div>
                    </div>
                    
                    <button type="submit">Save Monthly Goals</button>
                    
                    <div class="goals-summary">
                        <h3>Calculated Totals</h3>
                        <p>Total Unit Goal: <span id="total-goal-display">0</span></p>
                        <p>120% Bonus Goal: <span id="bonus-goal-display">0</span></p>
                        <p id="goals-last-updated">Last Updated: Never</p>
                    </div>
                </form>
            </div>

            <div id="ViewLogs" class="page-content">
                <h2>View Performance Logs</h2>
                <div class="form-section">
                    <label for="log-employee-select">Select Employee:</label>
                    <select id="log-employee-select">
                        <option value="">-- Select a Rep --</option>
                    </select>
                </div>
                
                <div class="form-section">
                    <button type="button" class="ai-button" id="generate-ai-coaching-plan" style="width: 100%; margin-top: 0;">Generate AI Coaching Plan</button>
                    <div class="loader" id="coaching-loader"></div>
                </div>
                <div id="ai-coaching-output" class="ai-coaching-output">
                </div>
                
                <div id="log-output">
                    <p>Please select an employee to view their logs.</p>
                </div>
            </div>

            <div id="Employees" class="page-content">
                <form id="addEmployeeForm">
                    <h2>Add New Employee</h2>
                    <div class="form-grid">
                        <div class="form-section">
                            <label for="new-employee-name">Employee Name:</label>
                            <input type="text" id="new-employee-name" placeholder="e.g., Rogers, Devin K" required>
                        </div>
                        <div class="form-section">
                            <label for="new-employee-role">Role:</label>
                            <input type="text" id="new-employee-role" placeholder="e.g., Greeter, Sales Rep" required>
                        </div>
                        <div class="grid-span-2 form-section">
                            <label for="new-employee-hire-date">Hire Date:</label>
                            <input type="date" id="new-employee-hire-date" name="hireDate" required>
                        </div>
                    </div>
                    <button type="submit">Add Employee</button>
                </form>
                
                <h2 style="margin-top: 30px;">Current Employees</h2>
                <ul id="employee-list">
                </ul>
            </div>
        </main>
    </div>

    <div id="editEmployeeModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn" id="modal-close-btn">&times;</span>
            <form id="editEmployeeForm">
                <h2>Edit Employee</h2>
                <input type="hidden" id="edit-employee-id" name="id">
                
                <div class="form-grid">
                    <div class="grid-span-2 form-section">
                        <label for="edit-employee-name">Employee Name:</label>
                        <input type="text" id="edit-employee-name" name="name" required>
                    </div>
                    <div class="form-section">
                        <label for="edit-employee-role">Role:</label>
                        <input type="text" id="edit-employee-role" name="role">
                    </div>
                    <div class="form-section">
                        <label for="edit-employee-hire-date">Hire Date:</label>
                        <input type="date" id="edit-employee-hire-date" name="hireDate">
                    </div>
                    <div class="grid-span-2 form-section">
                        <label for="edit-employee-strengths">Strengths:</label>
                        <textarea id="edit-employee-strengths" name="strengths" class="profile-notes" placeholder="e.g., Great at building rapport..."></textarea>
                    </div>
                    <div class="grid-span-2 form-section">
                        <label for="edit-employee-opportunities">Opportunities:</label>
                        <textarea id="edit-employee-opportunities" name="opportunities" class="profile-notes" placeholder="e.g., Needs to focus on..."></textarea>
                    </div>
                </div>
                <button type="submit">Save Changes</button>
                <button type="button" class="delete-btn" id="delete-employee-btn" style="background: var(--danger-color); margin-top: 15px;">Delete Employee</button>
            </form>
        </div>
    </div>
    
    <div id="toast-notification">
        <span id="toast-message"></span>
    </div>
    
    <div id="custom-prompt-modal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close-btn" id="prompt-close-btn">&times;</span>
            <p id="custom-prompt-message"></p>
            <input type="text" id="custom-prompt-input" style="width: 100%; margin-top: 10px;" />
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" id="prompt-cancel-btn" style="background: #aaa; width: auto;">Cancel</button>
                <button type="button" id="prompt-confirm-btn" style="background: var(--danger-color); width: auto;">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            collection, 
            onSnapshot, 
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Netlify Backend Helper ---
        async function callNetlifyGemini(promptText) {
            console.log("Sending prompt to AI..."); 
            const response = await fetch('/.netlify/functions/fetch-gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: promptText })
            });
            
            if (!response.ok) {
                throw new Error(`Netlify Error: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        // --- KPI Context ---
        const KPI_CONTEXT = `
            Please use the following Xfinity retail KPIs and expectations when generating SMART goals:
            - Reps are full-time, 5x8-hour shifts.
            - tNPS score goal: 75
            - XM% to goal: 100%
            - XM conversion rate: 10%
            - HSD to goal: 100%
            - Gigabit+ sell in: 50%
            - Video/CDV/XH unit % to goal: 100%
            - Wablets: Watch/Tablet sale: minimum 2 per week, recommended 4 per week, with attach rate of 45%
            - XMC attach: 60%
            - Unlimited Premium (higher mobile plan) attach: 45%
            - New/New (New mobile line attach on a new internet sale, same day): 30% attach
            - Monthly Mobile Line (LA) Goal: 40 per rep (approx 10-15 per week).
            - Total Monthly Unit Goal: Varies, but hitting 120% of this total (e.g., HSI+Video+XM+etc) gives a 20% commission bonus.
            - 'Service to sales' means every service interaction (like a bill pay or equipment swap)
              is an opportunity to perform an account review and pivot to a sale (especially Xfinity Mobile).
        `;

        // --- Firebase Config & App Variables ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaRTH_-SrDMlKePFfKUaUa0FeGDD1-KIA",
            authDomain: "retail-coaching-tool.firebaseapp.com",
            projectId: "retail-coaching-tool",
            storageBucket: "retail-coaching-tool.firebasestorage.app",
            messagingSenderId: "321362459125",
            appId: "1:321362459125:web:b35448ac90801a5e0388bc",
            measurementId: "G-K8RYLXRG5H"
        };
        
        const appId = firebaseConfig.projectId || 'default-app-id';
        const DELETE_FAILSAFE_CODE = "DELETE-1234"; 
        const AUTOSAVE_KEY = "obsFormAutosave"; 

        let db, auth, userId, googleProvider, app, analytics, currentUser; 
        
        // --- NEW: Multi-Store Variables ---
        let currentStore = null; // Will be set by modal
        let employeesRef, observationsRef, coachingsRef, storeGoalsRef; 
        
        // Listeners
        let employeesListener = null;
        let observationsListener = null;
        let coachingsListener = null;
        let storeGoalsListener = null; 

        // Global state variables
        let localEmployees = {};
        let localObservations = [];
        let localCoachings = [];
        let localStoreGoals = {}; 
        
        const OBS_GOAL = 4;
        const COACH_GOAL = 2;
            </div>
        // --- Helper Functions ---
        
        function getFirstName(fullName) {
            if (!fullName) return "the employee";
            try {
                const parts = fullName.split(',');
                if (parts.length > 1) {
                    const firstNameParts = parts[1].trim().split(' ');
                    return firstNameParts[0];
                } else {
                    const parts = fullName.trim().split(' ');
                    return parts[0];
                }
            } catch (e) {
                console.error("Error parsing name:", e);
                return fullName; 
            }
        }
        
        function isGreeterRole(role) {
            if (!role) return false;
            return role.toLowerCase().includes('greeter');
        }

        function calculateTenure(hireDate) {
            if (!hireDate) return "";
            const start = hireDate.toDate ? hireDate.toDate() : new Date(hireDate);
            const end = new Date();
            end.setMinutes(end.getMinutes() - end.getTimezoneOffset());
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            if (months < 0) {
                years--;
                months += 12;
            }
            let tenureStr = "";
            if (years > 0) tenureStr += `${years} yr${years > 1 ? 's' : ''}`;
            if (months > 0) {
                if (tenureStr) tenureStr += ", ";
                tenureStr += `${months} mo${months > 1 ? 's' : ''}`;
            }
            if (tenureStr === "") {
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24));
                return ` (${days} days)`;
            }
            return ` (${tenureStr})`;
        }
        
        function getFiscalMonthInfo(date) {
            const day = date.getDate();
            let startMonth = date.getMonth();
            let startYear = date.getFullYear();
            let endMonth = date.getMonth();
            let endYear = date.getFullYear();
            if (day < 22) {
                endMonth = date.getMonth();
                endYear = date.getFullYear();
                startMonth = date.getMonth() - 1;
                startYear = date.getFullYear();
                if (startMonth < 0) {
                    startMonth = 11; 
                    startYear -= 1;
                }
            } else {
                startMonth = date.getMonth();
                startYear = date.getFullYear();
                endMonth = date.getMonth() + 1;
                endYear = date.getFullYear();
                if (endMonth > 11) {
                    endMonth = 0; 
                    endYear += 1;
                }
            }
            const startDate = new Date(startYear, startMonth, 22, 0, 0, 0);
            const endDate = new Date(endYear, endMonth, 21, 23, 59, 59);
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const fiscalMonthName = `Fiscal ${monthNames[endMonth]} ${endYear}`;
            return { startDate, endDate, name: fiscalMonthName };
        }

        // --- UI Builders ---
        function populateEmployeeDropdown(selectId) {
            const employeeSelect = document.getElementById(selectId);
            const selectedValue = employeeSelect.value;
            employeeSelect.innerHTML = '<option value="">-- Select a Rep --</option>';
            const sortedEmployees = Object.entries(localEmployees).sort(([, a], [, b]) => a.name.localeCompare(b.name));
            for (const [id, profile] of sortedEmployees) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = profile.name;
                employeeSelect.appendChild(option);
            }
            employeeSelect.value = selectedValue;
        }

        function populateEmployeeList() {
            const employeeList = document.getElementById('employee-list');
            employeeList.innerHTML = '';
            const sortedEmployees = Object.entries(localEmployees).sort(([, a], [, b]) => a.name.localeCompare(b.name));
            for (const [id, profile] of sortedEmployees) {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <span class="employee-list-name">${profile.name}</span>
                        ${profile.role ? `<span class="employee-list-role"> (${profile.role})</span>` : ''}
                        <span class="employee-list-tenure">${calculateTenure(profile.hireDate)}</span>
                    </div>
                `;
                li.addEventListener('click', () => openEditModal(id, profile));
                employeeList.appendChild(li);
            }
        }
        
        function displayEmployeeLogs(employeeId) {
            const logOutput = document.getElementById('log-output');
            const coachingOutput = document.getElementById('ai-coaching-output');
            logOutput.innerHTML = ''; 
            coachingOutput.style.display = 'none';
            coachingOutput.innerHTML = '';
            
            if (!employeeId) {
                logOutput.innerHTML = '<p>Please select an employee to view their logs.</p>';
                return;
            }
            
            const employeeLogs = localObservations.filter(obs => obs.employeeId === employeeId);
            const employeeCoachings = localCoachings.filter(c => c.employeeId === employeeId);
            const combinedLogs = [...employeeLogs, ...employeeCoachings];
            combinedLogs.sort((a, b) => b.date.toDate() - a.date.toDate());
            
            const employeeName = localEmployees[employeeId]?.name || "Unknown Employee";
            
            if (combinedLogs.length === 0) {
                logOutput.innerHTML = `<p>No observations or coaching logs found for ${employeeName}.</p>`;
                return;
            }
            
            for (const log of combinedLogs) { 
                const entryDiv = document.createElement('div');
                entryDiv.className = 'log-entry';
                
                const deleteBtnHtml = `<button class="log-delete-btn" onclick="window.deleteLog('${log.id}', '${log.greatAssessment ? 'observations' : 'coachings'}', '${log.greatAssessment ? 'Observation' : 'Coaching'}')"><i class="fa-solid fa-trash-can"></i> Delete</button>`;
                
                let contentHtml = `
                    <div class="log-entry-header">
                        <p class="log-entry-date">${log.date.toDate().toLocaleString()}</p>
                        ${deleteBtnHtml}
                    </div>
                    ${log.loggedBy ? `<p class="log-byline">Logged by: <strong>${log.loggedBy}</strong></p>` : ''}
                `;

                if (log.greatAssessment) {
                    // Observation Logic
                    if(log.customerIntent) contentHtml += `<p class="log-customer-intent">Customer Intent: <span>${log.customerIntent}</span></p>`;
                    
                    contentHtml += `<div class="log-entry-great">`;
                    const steps = ['greet', 'relate', 'explore', 'ask', 'thank'];
                    for (const step of steps) {
                        const data = log.greatAssessment[step];
                        if (!data) continue;
                        const title = step.charAt(0).toUpperCase() + step.slice(1);
                        contentHtml += `<p><strong>${title}</strong>${data.measurement ? ` <span class="log-step-measurement">(${data.measurement})</span>` : ''}</p>`;
                        if (data.behaviors && data.behaviors.length > 0) {
                            contentHtml += `<ul>${data.behaviors.map(b => `<li>${b}</li>`).join('')}</ul>`;
                        }
                        if (data.notes && data.notes.trim()) {
                            contentHtml += `<div class="log-step-notes">${data.notes}</div>`;
                        }
                    }
                    contentHtml += `</div>`;
                    if (log.notes) contentHtml += `<p><strong>Overall Notes:</strong> ${log.notes}</p>`;
                    
                } else if (log.actionPlan) { 
                    // Coaching Logic
                    contentHtml += `
                        <div class="log-entry-coaching">
                            <h4>Coaching Session Log</h4>
                            <p><strong>tNPS Logged:</strong> ${log.tnps || 'N/A'}</p>
                            <p><strong>Sales Logged:</strong> ${log.sales || 'N/A'}</p>
                            <p><strong>Progress:</strong> ${log.progress || 'N/A'}</p>
                            <p><strong>Challenges:</strong> ${log.obstacles || 'N/A'}</p>
                            <p><strong>Action Plan:</strong> ${log.actionPlan || 'N/A'}</p>
                        </div>
                    `;
                }
                entryDiv.innerHTML = contentHtml;
                logOutput.appendChild(entryDiv);
            }
        }
        
        // --- TRACKER LOGIC with Exemptions ---
        // We will store exemptions in the storeGoals collection for simplicity (as a sub-collection or just a document)
        // Actually, let's just make a 'exemptions' collection per store.
        let exemptionsRef;
        let localExemptions = {};
        
        async function toggleExempt(employeeId) {
            const fiscalMonth = getFiscalMonthInfo(new Date());
            const key = `${employeeId}_${fiscalMonth.name.replace(/\s/g, '')}`;
            
            // Check current status
            const currentStatus = localExemptions[key]?.isExempt || false;
            const newStatus = !currentStatus;
            
            try {
                // If turning ON exemption
                if (newStatus) {
                    await setDoc(doc(exemptionsRef, key), {
                        employeeId: employeeId,
                        month: fiscalMonth.name,
                        isExempt: true,
                        timestamp: Timestamp.now()
                    });
                    showToast("Marked as Exempt");
                } else {
                    // If turning OFF
                    await deleteDoc(doc(exemptionsRef, key));
                    showToast("Exemption Removed");
                }
            } catch(e) {
                console.error("Error toggling exempt:", e);
                showToast("Error updating status", true);
            }
        }
        window.toggleExempt = toggleExempt; // Global scope for HTML click

        function updateTrackerTab() {
            try {
                const fiscalMonth = getFiscalMonthInfo(new Date());
                document.getElementById('tracker-title').textContent = `Monthly Goal Tracker`;
                document.getElementById('tracker-subtitle').textContent = `${fiscalMonth.name} (${fiscalMonth.startDate.toLocaleDateString()} - ${fiscalMonth.endDate.toLocaleDateString()})`;
                
                const tableBody = document.getElementById('tracker-table-body');
                tableBody.innerHTML = ''; 

                const obsInMonth = localObservations.filter(obs => {
                    const date = obs.date.toDate();
                    return date >= fiscalMonth.startDate && date <= fiscalMonth.endDate;
                });
                const coachingInMonth = localCoachings.filter(c => {
                    const date = c.date.toDate();
                    return date >= fiscalMonth.startDate && date <= fiscalMonth.endDate;
                });

                const sortedEmployees = Object.entries(localEmployees).sort(([, a], [, b]) => a.name.localeCompare(b.name));

                for (const [id, profile] of sortedEmployees) {
                    const employeeObs = obsInMonth.filter(obs => obs.employeeId === id);
                    const employeeCoaching = coachingInMonth.filter(c => c.employeeId === id);
                    
                    const obsCount = employeeObs.length;
                    const coachCount = employeeCoaching.length;
                    
                    const obsMet = obsCount >= OBS_GOAL;
                    const coachMet = coachCount >= COACH_GOAL;
                    let isComplete = obsMet && coachMet;
                    
                    // Check exemption
                    const exemptKey = `${id}_${fiscalMonth.name.replace(/\s/g, '')}`;
                    const isExempt = localExemptions[exemptKey]?.isExempt || false;
                    
                    const tr = document.createElement('tr');
                    
                    let statusClass = 'status-progress';
                    let statusText = 'In Progress';
                    
                    if (isExempt) {
                        statusClass = 'status-complete'; // Or special class
                        statusText = '<span class="status-exempt">EXEMPT / LOA</span>';
                    } else if (isComplete) {
                        statusClass = 'status-complete';
                        statusText = '<i class="fa-solid fa-check-circle"></i> Complete';
                    }
                    
                    // Exempt Toggle Button
                    const exemptBtn = `<button class="exempt-toggle-btn ${isExempt ? 'active' : ''}" onclick="window.toggleExempt('${id}')">${isExempt ? 'Un-Exempt' : 'Mark Exempt'}</button>`;
                    
                    // Name Cell with Exempt Button
                    const nameCell = document.createElement('td');
                    nameCell.innerHTML = `<div>${profile.name} ${exemptBtn}</div>`;
                    tr.appendChild(nameCell);
                    
                    const roleCell = document.createElement('td');
                    roleCell.textContent = profile.role;
                    tr.appendChild(roleCell);

                    // Pips logic...
                    const obsCell = document.createElement('td');
                    let obsPips = `<div class="progress-pips">`;
                    // ... (Pip generation same as before)
                    for(let i=0; i<obsCount; i++) obsPips += `<span class="progress-pip filled"></span>`;
                    for(let i=obsCount; i<OBS_GOAL; i++) obsPips += `<span class="progress-pip"></span>`;
                    obsPips += `</div>`;
                    obsCell.innerHTML = obsPips;
                    tr.appendChild(obsCell);
                    
                    const coachCell = document.createElement('td');
                    let coachPips = `<div class="progress-pips">`;
                    for(let i=0; i<coachCount; i++) coachPips += `<span class="progress-pip filled"></span>`;
                    for(let i=coachCount; i<COACH_GOAL; i++) coachPips += `<span class="progress-pip"></span>`;
                    coachPips += `</div>`;
                    coachCell.innerHTML = coachPips;
                    tr.appendChild(coachCell);
                    
                    const statusCell = document.createElement('td');
                    statusCell.className = statusClass;
                    statusCell.innerHTML = statusText;
                    tr.appendChild(statusCell);
                    
                    tableBody.appendChild(tr);
                }
            } catch (error) {
                console.error("Error updating tracker tab:", error);
            }
        }
        
        // --- Store Goals Logic ---
        function displayStoreGoals() {
            const form = document.getElementById('goalsForm');
            form.xm.value = localStoreGoals.xm || '';
            form.hsi.value = localStoreGoals.hsi || '';
            form.video.value = localStoreGoals.video || '';
            form.cdv.value = localStoreGoals.cdv || '';
            form.xhs.value = localStoreGoals.xhs || '';
            form.upgrades.value = localStoreGoals.upgrades || '';
            const total = (localStoreGoals.xm || 0) + (localStoreGoals.hsi || 0) + (localStoreGoals.video || 0) + (localStoreGoals.cdv || 0) + (localStoreGoals.xhs || 0) + (localStoreGoals.upgrades || 0);
            const bonus = Math.ceil(total * 1.2);
            document.getElementById('total-goal-display').textContent = total;
            document.getElementById('bonus-goal-display').textContent = bonus;
            if (localStoreGoals.lastUpdated) {
                document.getElementById('goals-last-updated').textContent = `Last Updated: ${localStoreGoals.lastUpdated.toDate().toLocaleString()}`;
            } else {
                document.getElementById('goals-last-updated').textContent = 'Last Updated: Never';
            }
        }
        
        function checkGoalDate() {
            const warningIcon = document.getElementById('nav-goals-warning');
            if (!localStoreGoals.lastUpdated) {
                warningIcon.style.display = 'inline';
                return;
            }
            const fiscalMonth = getFiscalMonthInfo(new Date());
            const lastUpdatedDate = localStoreGoals.lastUpdated.toDate();
            if (lastUpdatedDate < fiscalMonth.startDate) {
                warningIcon.style.display = 'inline';
            } else {
                warningIcon.style.display = 'none';
            }
        }

        // --- Core AI Functions ---

        async function generateAndLogObservation() {
            const form = document.getElementById('obsForm');
            const employeeId = form.employee.value;
            const customerIntent = form.customerIntent.value.trim();
            if (!employeeId) { showToast("Please select an employee first.", true); return; }
            if (!customerIntent) { showToast("Please enter the customer intent first.", true); return; }
            
            const profile = localEmployees[employeeId];
            const firstName = getFirstName(profile.name);
            
            // Collect behaviors
            const getCheckboxes = (name) => Array.from(form.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
            const getRadio = (name) => { const r = form.querySelector(`input[name="${name}"]:checked`); return r ? r.value : "N/A"; };

            const greatData = {
                greet: { measurement: getRadio('great_g_measure'), behaviors: getCheckboxes('great_g') },
                relate: { measurement: getRadio('great_r_measure'), behaviors: getCheckboxes('great_r') },
                explore: { measurement: getRadio('great_e_measure'), behaviors: getCheckboxes('great_e') },
                ask: { measurement: getRadio('great_a_measure'), behaviors: getCheckboxes('great_a') },
                thank: { measurement: getRadio('great_t_measure'), behaviors: getCheckboxes('great_t') }
            };
            
            let prompt = `Act as a retail sales manager for an **Xfinity store**.
            I am observing ${firstName} (${profile.role}). Customer Intent: ${customerIntent}.
            
            G: ${greatData.greet.measurement} [${greatData.greet.behaviors.join(', ')}]
            R: ${greatData.relate.measurement} [${greatData.relate.behaviors.join(', ')}]
            E: ${greatData.explore.measurement} [${greatData.explore.behaviors.join(', ')}]
            A: ${greatData.ask.measurement} [${greatData.ask.behaviors.join(', ')}]
            T: ${greatData.thank.measurement} [${greatData.thank.behaviors.join(', ')}]
            
            Generate strictly valid JSON with keys: "greet_note", "relate_note", "explore_note", "ask_note", "thank_note", "manager_verbatim" (script for me).
            If behaviors are empty and partial/missed, mention that.`;
            
            showLoading('summary-loader', 'generate-and-log-ai-summary', true, 'Generating...');
            
            try {
                const result = await callNetlifyGemini(prompt);
                let cleanJson = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '');
                const firstBrace = cleanJson.indexOf('{');
                const lastBrace = cleanJson.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) cleanJson = cleanJson.substring(firstBrace, lastBrace + 1);
                const notesObject = JSON.parse(cleanJson);

                if (notesObject.greet_note) form.notes_g.value = notesObject.greet_note;
                if (notesObject.relate_note) form.notes_r.value = notesObject.relate_note;
                if (notesObject.explore_note) form.notes_e.value = notesObject.explore_note;
                if (notesObject.ask_note) form.notes_a.value = notesObject.ask_note;
                if (notesObject.thank_note) form.notes_t.value = notesObject.thank_note;
                
                if (notesObject.manager_verbatim) {
                    document.getElementById('verbatim-feedback-output').innerHTML = notesObject.manager_verbatim.replace(/\n/g, '<br>');
                    document.getElementById('verbatim-feedback-section').style.display = 'block';
                }
                document.querySelectorAll('.copy-btn').forEach(btn => btn.style.display = 'block');

                // Save
                const newObservation = {
                    employeeId: employeeId,
                    date: Timestamp.now(),
                    customerIntent: customerIntent,
                    greatAssessment: {
                        greet: { ...greatData.greet, notes: form.notes_g.value },
                        relate: { ...greatData.relate, notes: form.notes_r.value },
                        explore: { ...greatData.explore, notes: form.notes_e.value },
                        ask: { ...greatData.ask, notes: form.notes_a.value },
                        thank: { ...greatData.thank, notes: form.notes_t.value }
                    },
                    notes: form.notes.value.trim(),
                    loggedBy: currentUser.displayName || currentUser.email
                };
                await addDoc(observationsRef, newObservation);
                showToast(`Logged for ${profile.name}!`);
                clearAutosave();
                
            } catch (err) {
                console.error('AI Gen Failed:', err);
                showToast('AI generation failed. Check console.', true);
            } finally {
                showLoading('summary-loader', 'generate-and-log-ai-summary', false);
            }
        }

        async function generateAndLogCoachingNotes() {
            const form = document.getElementById('coachingForm');
            const employeeId = form.employeeId.value;
            if (!employeeId) { showToast("Select employee.", true); return; }
            
            const rawProgress = form.progress.value.trim();
            const rawObstacles = form.obstacles.value.trim();
            const rawActionPlan = form.actionPlan.value.trim();
            
            if (!rawProgress || !rawObstacles || !rawActionPlan) {
                showToast("Please fill in raw notes first.", true); return;
            }
            
            const profile = localEmployees[employeeId];
            let prompt = `Act as Xfinity Manager. Refine coaching notes for ${profile.name}.
            Raw Progress: ${rawProgress}
            Raw Obstacles: ${rawObstacles}
            Raw Action Plan: ${rawActionPlan}
            Generate strictly valid JSON: "progress_note", "obstacles_note", "action_plan" (SMART Goal).`;
            
            showLoading('coaching-notes-loader', 'generate-ai-coaching-notes', true, 'Generating...');
            
            try {
                const result = await callNetlifyGemini(prompt);
                let cleanJson = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '');
                const firstBrace = cleanJson.indexOf('{');
                const lastBrace = cleanJson.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) cleanJson = cleanJson.substring(firstBrace, lastBrace + 1);
                const notesObject = JSON.parse(cleanJson);

                // Auto-fill refined notes
                if (notesObject.progress_note) form.progress.value = notesObject.progress_note;
                if (notesObject.obstacles_note) form.obstacles.value = notesObject.obstacles_note;
                if (notesObject.action_plan) form.actionPlan.value = notesObject.action_plan;

                // Save
                const newCoaching = {
                    employeeId: employeeId,
                    date: Timestamp.now(),
                    tnps: form.tnps.value || "",
                    sales: form.sales.value || "",
                    progress: form.progress.value,
                    obstacles: form.obstacles.value,
                    actionPlan: form.actionPlan.value,
                    loggedBy: currentUser.displayName || currentUser.email
                };
                await addDoc(coachingsRef, newCoaching);
                showToast(`Coaching logged for ${profile.name}!`);
                
                // DO NOT RESET FORM AUTOMATICALLY
                
            } catch (err) {
                console.error('AI Coaching Failed:', err);
                showToast('Failed. Check console.', true);
            } finally {
                showLoading('coaching-notes-loader', 'generate-ai-coaching-notes', false);
            }
        }

        // --- Store Routing Logic ---
        
        window.selectStore = function(storeName) {
            currentStore = storeName;
            document.getElementById('store-selector-modal').style.display = 'none';
            document.getElementById('current-store-badge').textContent = storeName;
            
            // Re-initialize listeners with new paths
            if (userId) {
                setupFirestoreListeners();
            }
        };

        function setupFirestoreListeners() {
            // Unsubscribe existing listeners
            if (employeesListener) employeesListener();
            if (observationsListener) observationsListener();
            if (coachingsListener) coachingsListener();
            if (storeGoalsListener) storeGoalsListener();
            if (window.exemptionsListener) window.exemptionsListener();

            let employeesPath, observationsPath, coachingsPath, storeGoalsDocPath, exemptionsPath;

            // PRESERVE WILLISTON DATA PATHS EXACTLY
            if (currentStore === 'Williston') {
                employeesPath = `artifacts/${appId}/public/data/employees`;
                observationsPath = `artifacts/${appId}/public/data/observations`;
                coachingsPath = `artifacts/${appId}/public/data/coachings`;
                // Special case for Store Goals in Williston legacy setup
                storeGoalsDocPath = doc(db, "artifacts", appId, "public", "data", "storeGoals", "currentMonth");
                exemptionsPath = `artifacts/${appId}/public/data/exemptions`; // New path for Williston
            } else {
                // New paths for other stores
                const basePath = `stores/${currentStore}`;
                employeesPath = `${basePath}/employees`;
                observationsPath = `${basePath}/observations`;
                coachingsPath = `${basePath}/coachings`;
                storeGoalsDocPath = doc(db, basePath, "storeGoals", "currentMonth");
                exemptionsPath = `${basePath}/exemptions`;
            }

            // Set References
            employeesRef = collection(db, employeesPath);
            observationsRef = collection(db, observationsPath);
            coachingsRef = collection(db, coachingsPath);
            storeGoalsRef = storeGoalsDocPath;
            exemptionsRef = collection(db, exemptionsPath);

            // Listeners
            employeesListener = onSnapshot(employeesRef, (snapshot) => {
                localEmployees = {};
                snapshot.forEach((doc) => { localEmployees[doc.id] = { ...doc.data(), id: doc.id }; });
                refreshUI();
            });

            observationsListener = onSnapshot(observationsRef, (snapshot) => {
                localObservations = [];
                snapshot.forEach((doc) => { localObservations.push({ ...doc.data(), id: doc.id }); });
                displayEmployeeLogs(document.getElementById('log-employee-select').value);
                if(document.getElementById('Tracker').classList.contains('active')) updateTrackerTab();
            });

            coachingsListener = onSnapshot(coachingsRef, (snapshot) => {
                localCoachings = [];
                snapshot.forEach((doc) => { localCoachings.push({ ...doc.data(), id: doc.id }); });
                displayEmployeeLogs(document.getElementById('log-employee-select').value);
                displayLastSMARTGoal(document.getElementById('employee').value);
                if(document.getElementById('Tracker').classList.contains('active')) updateTrackerTab();
            });

            storeGoalsListener = onSnapshot(storeGoalsRef, (doc) => {
                localStoreGoals = doc.data() || {};
                if(document.getElementById('Goals').classList.contains('active')) displayStoreGoals();
                checkGoalDate();
            });
            
            // Exemption Listener
            window.exemptionsListener = onSnapshot(exemptionsRef, (snapshot) => {
                localExemptions = {};
                snapshot.forEach((doc) => { localExemptions[doc.id] = doc.data(); });
                if(document.getElementById('Tracker').classList.contains('active')) updateTrackerTab();
            });
        }
        
        // --- Refresh UI Helper ---
        function refreshUI() {
            populateEmployeeDropdown('employee'); 
            populateEmployeeDropdown('log-employee-select'); 
            populateEmployeeDropdown('coaching-employee-select'); 
            populateEmployeeList(); 
            displayEmployeeLogs(document.getElementById('log-employee-select').value);
            if(document.getElementById('Tracker').classList.contains('active')) updateTrackerTab();
            if(document.getElementById('Goals').classList.contains('active')) displayStoreGoals();
            checkGoalDate();
        }
        
        // --- Miscellaneous Logic (Auth, Autosave, etc.) from previous code ---
        async function saveStoreGoals(event) {
            event.preventDefault();
            const form = document.getElementById('goalsForm');
            const goals = {
                xm: Number(form.xm.value) || 0,
                hsi: Number(form.hsi.value) || 0,
                video: Number(form.video.value) || 0,
                cdv: Number(form.cdv.value) || 0,
                xhs: Number(form.xhs.value) || 0,
                upgrades: Number(form.upgrades.value) || 0,
            };
            const total = goals.xm + goals.hsi + goals.video + goals.cdv + goals.xhs + goals.upgrades;
            const bonus = Math.ceil(total * 1.2);
            const goalsToSave = { ...goals, totalGoal: total, bonusGoal: bonus, lastUpdated: Timestamp.now() };
            await setDoc(storeGoalsRef, goalsToSave);
            showToast("Monthly goals saved!");
        }
        
        function resetObsForm(fullReset = false) {
            const form = document.getElementById('obsForm');
            form.reset();
            if (fullReset) form.employee.value = "";
            form.querySelectorAll('input[value="Partial"]').forEach(radio => radio.checked = true);
            document.getElementById('last-goal-display').style.display = 'none';
            document.getElementById('verbatim-feedback-section').style.display = 'none';
            document.getElementById('verbatim-feedback-output').innerHTML = '';
            document.querySelectorAll('.copy-btn').forEach(btn => btn.style.display = 'none');
            if (fullReset) clearAutosave();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const appWrapper = document.getElementById('app-wrapper');
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                googleProvider = new GoogleAuthProvider();
                
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        userId = user.uid;
                        appWrapper.classList.remove('logged-out');
                        document.getElementById('sign-in-btn').style.display = 'none';
                        const signOutBtn = document.getElementById('sign-out-btn');
                        signOutBtn.style.display = 'flex';
                        signOutBtn.querySelector('.auth-text').textContent = `Sign Out (${user.displayName})`;
                        
                        // Wait for store selection if not yet picked
                        if (currentStore) setupFirestoreListeners();
                    } else {
                        userId = null;
                        appWrapper.classList.add('logged-out');
                        document.getElementById('sign-in-btn').style.display = 'flex';
                        document.getElementById('sign-out-btn').style.display = 'none';
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                showToast("Connection Error", true);
            }

            // Event Listeners
            document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newEmp = {
                    name: document.getElementById('new-employee-name').value.trim(),
                    role: document.getElementById('new-employee-role').value.trim(),
                    hireDate: document.getElementById('new-employee-hire-date').value,
                    strengths: "", opportunities: ""
                };
                await addDoc(employeesRef, newEmp);
                showToast("Employee added!");
                e.target.reset();
            });

            document.getElementById('editEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-employee-id').value;
                const updated = {
                    name: document.getElementById('edit-employee-name').value.trim(),
                    role: document.getElementById('edit-employee-role').value.trim(),
                    hireDate: document.getElementById('edit-employee-hire-date').value,
                    strengths: document.getElementById('edit-employee-strengths').value.trim(),
                    opportunities: document.getElementById('edit-employee-opportunities').value.trim()
                };
                await setDoc(doc(employeesRef, id), updated, { merge: true });
                showToast("Employee saved!");
                document.getElementById('editEmployeeModal').style.display = 'none';
            });
            
            document.getElementById('delete-employee-btn').addEventListener('click', async () => {
                const id = document.getElementById('edit-employee-id').value;
                const code = prompt(`Type DELETE-1234 to confirm deleting this employee:`);
                if(code === DELETE_FAILSAFE_CODE) {
                    await deleteDoc(doc(employeesRef, id));
                    showToast("Employee deleted.");
                    document.getElementById('editEmployeeModal').style.display = 'none';
                }
            });

            document.getElementById('generate-and-log-ai-summary').addEventListener('click', generateAndLogObservation);
            document.getElementById('generate-ai-coaching-notes').addEventListener('click', generateAndLogCoachingNotes);
            document.getElementById('goalsForm').addEventListener('submit', saveStoreGoals);
            document.getElementById('sign-in-btn').addEventListener('click', () => signInWithPopup(auth, googleProvider));
            document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));
            
            // UI Toggles
            document.getElementById('modal-close-btn').onclick = () => document.getElementById('editEmployeeModal').style.display = 'none';
            window.onclick = (e) => { if (e.target == document.getElementById('editEmployeeModal')) document.getElementById('editEmployeeModal').style.display = 'none'; };
            document.getElementById('sidebar-toggle-btn').onclick = () => appWrapper.classList.toggle('sidebar-collapsed');
            
            // Clear Coaching Form Listener
            document.getElementById('clear-coaching-btn').addEventListener('click', () => {
                if(confirm('Clear all coaching fields?')) {
                    document.getElementById('coachingForm').reset();
                    document.getElementById('coaching-date').valueAsDate = new Date();
                }
            });
            
            // Copy Btns
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const el = document.getElementById(btn.dataset.target);
                    const text = el.tagName === 'TEXTAREA' ? el.value : el.innerText;
                    navigator.clipboard.writeText(text);
                    const original = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = original, 1500);
                });
            });

            // Globals
            window.openPage = function(event, pageName) {
                Array.from(document.getElementsByClassName('page-content')).forEach(p => p.style.display = 'none');
                Array.from(document.getElementsByClassName('nav-link')).forEach(l => l.classList.remove('active'));
                document.getElementById(pageName).style.display = 'block';
                event.currentTarget.classList.add('active');
                refreshUI();
            };
            
            // Delete Log Global Wrapper
            window.deleteLog = async (id, collectionName, typeName) => {
                const code = prompt(`Type DELETE-1234 to delete this ${typeName}:`);
                if(code === DELETE_FAILSAFE_CODE) {
                    if (collectionName === 'observations') await deleteDoc(doc(observationsRef, id));
                    else await deleteDoc(doc(coachingsRef, id));
                    showToast(`${typeName} deleted.`);
                }
            };
            
            // Modal Open Wrapper
            window.openEditModal = (id, profile) => {
                document.getElementById('edit-employee-id').value = id;
                document.getElementById('edit-employee-name').value = profile.name;
                document.getElementById('edit-employee-role').value = profile.role || '';
                document.getElementById('edit-employee-hire-date').value = profile.hireDate || '';
                document.getElementById('edit-employee-strengths').value = profile.strengths || '';
                document.getElementById('edit-employee-opportunities').value = profile.opportunities || '';
                document.getElementById('editEmployeeModal').style.display = 'block';
            };
            
            // Autosave Logic (Observation)
            const obsForm = document.getElementById('obsForm');
            obsForm.addEventListener('input', () => {
                 const data = new FormData(obsForm);
                 const obj = {};
                 data.forEach((value, key) => obj[key] = value);
                 localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(obj));
            });
            const saved = localStorage.getItem(AUTOSAVE_KEY);
            if(saved) {
                const obj = JSON.parse(saved);
                for(const key in obj) {
                    const el = obsForm.elements[key];
                    if(el) {
                        if(el.type === 'radio') {
                             const r = obsForm.querySelector(`input[name="${key}"][value="${obj[key]}"]`);
                             if(r) r.checked = true;
                        } else if (el.type !== 'file' && el.type !== 'checkbox') {
                            el.value = obj[key];
                        }
                    }
                }
            }
            window.clearAutosave = () => localStorage.removeItem(AUTOSAVE_KEY);
            
            // Display Last Smart Goal logic for Coaching
            function displayLastSMARTGoal(empId) {
               // (Logic handled in listener, but function placeholder needed if called elsewhere)
            }
            // Add listener for Coaching Employee Select
            document.getElementById('coaching-employee-select').addEventListener('change', async (e) => {
                 // Simple AI recommendation trigger (Optional)
            });
            
        });
    </script>
</body>
</html>
